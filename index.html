<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KiteForecast — Windfinder stijl</title>
<style>
  /* Algemene layout */
  :root{
    --bg:#eaf6ff; --card:#ffffff; --accent:#0b6fb8; --muted:#6b7b8a;
    --accent-dark:#075a92; --good:#0b9b6e; --warn:#f59e0b;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#f3fbff);color:#042b3a}
  .wrap{max-width:980px;margin:18px auto;padding:12px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:1.4rem;color:var(--accent-dark)}
  .subtitle{color:var(--muted);font-size:0.9rem}

  /* Search card */
  .searchCard{background:var(--card);border-radius:10px;padding:12px;margin-top:12px;box-shadow:0 6px 18px rgba(6,30,50,0.06);display:flex;gap:10px;align-items:center}
  input[type="search"]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid #d7eefc;font-size:0.95rem}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
  .results{margin-top:8px;color:var(--muted);font-size:0.9rem}

  /* Spot header */
  .spotHeader{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
  .spotCard{background:linear-gradient(180deg,#ffffff, #f7fbff);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(6,30,50,0.04)}
  .spotMeta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:0.9rem}

  /* Forecast table (Windfinder-like) */
  .wf-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.92rem}
  .wf-table thead th{background:linear-gradient(180deg,#e6f6ff,#dff3ff);color:var(--accent-dark);padding:8px 10px;text-align:left;font-weight:700;border-bottom:1px solid #d7eefc}
  .wf-table tbody td{padding:8px 10px;border-bottom:1px solid #f0f6fb;vertical-align:middle}
  .day-row{background:#f3fbff;color:var(--accent-dark);font-weight:700}
  .slot-row:hover{background:#f7fdff}
  .super-row{background:linear-gradient(90deg,#fff7e6,#fff4e0);font-weight:700;color:#6b4a00}

  /* Wind arrow */
  .wind-cell{display:flex;align-items:center;gap:8px}
  .wind-arrow{
    width:18px;height:18px;border-radius:3px;background:linear-gradient(180deg,#0b6fb8,#075a92);display:inline-block;
    transform-origin:center center;box-shadow:0 1px 2px rgba(0,0,0,0.12);
    position:relative;
  }
  .wind-arrow::after{
    content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-60%) rotate(45deg);
    width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:8px solid #fff;
  }
  .kts{font-weight:700;color:#042b3a}
  .gust{color:var(--muted);font-size:0.9rem}
  .time{color:var(--muted);font-weight:600}

  /* compact labels */
  .pill{background:#e6f6ff;color:var(--accent-dark);padding:6px 8px;border-radius:999px;font-weight:700;font-size:0.85rem}

  /* responsive */
  @media(max-width:640px){
    .wf-table thead th:nth-child(1), .wf-table td:nth-child(1){display:none}
    .wind-arrow{width:16px;height:16px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>KiteForecast</h1>
      <div class="subtitle">Windfinder‑stijl weergave — 2‑uurs slots 08:00–20:00 • windsnelheden in kts</div>
    </div>
  </header>

  <div class="searchCard" role="search">
    <input id="q" type="search" placeholder="Zoek spot — bijv. Tarifa, Langebaan, Scheveningen" />
    <button id="searchBtn">Zoek</button>
  </div>
  <div id="results" class="results"></div>

  <div id="spotCard"></div>
</div>

<script>
/* API endpoints */
const GEOCODE = name => `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=10&language=nl&format=json`;
const FORECAST = (lat,lon,days=4) => `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=windspeed_10m,windgusts_10m,winddirection_10m&current_weather=true&timezone=auto&forecast_days=${days}`;

/* conversions */
const msToKts = ms => (ms * 1.943844).toFixed(1);
const degToCompass = deg => {
  if (deg === null || deg === undefined || isNaN(deg)) return '—';
  const val = Math.floor((deg/22.5)+0.5);
  const arr = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return arr[(val % 16)];
};

/* UI: search */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  const resEl = document.getElementById('results');
  resEl.textContent = 'Zoeken...';
  try{
    const r = await fetch(GEOCODE(q));
    const j = await r.json();
    if(!j.results || j.results.length===0){ resEl.textContent='Geen resultaten'; return; }
    const list = j.results.map((s,i)=>`<div style="margin-top:8px"><button data-i="${i}" class="spotBtn" style="background:transparent;border:0;color:var(--accent-dark);font-weight:700;cursor:pointer">${s.name}${s.admin1? ', '+s.admin1:''}, ${s.country} — ${s.latitude.toFixed(3)}, ${s.longitude.toFixed(3)}</button></div>`).join('');
    resEl.innerHTML = list;
    document.querySelectorAll('.spotBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const idx = btn.dataset.i;
        const spot = j.results[idx];
        loadSpot(spot);
      });
    });
  }catch(e){
    resEl.textContent='Fout bij zoeken';
  }
});

/* Main loader: builds Windfinder-like table with superforecast row per day */
async function loadSpot(spot){
  const container = document.getElementById('spotCard');
  container.innerHTML = `<div class="spotCard"><div style="font-weight:700">${spot.name}, ${spot.country}</div><div class="subtitle">Laden forecast…</div></div>`;
  try{
    const r = await fetch(FORECAST(spot.latitude, spot.longitude, 4));
    const j = await r.json();
    const cur = j.current_weather;
    const hourly = j.hourly;
    if(!hourly || !hourly.time){ container.innerHTML = `<div class="spotCard">Geen forecastdata beschikbaar</div>`; return; }

    // map time -> index
    const timeIndex = {};
    hourly.time.forEach((t,i)=> timeIndex[t] = i);

    // prepare days: today + next 2
    const days = [];
    for(let d=0; d<3; d++){
      const dt = new Date();
      dt.setDate(dt.getDate() + d);
      days.push(dt.toISOString().slice(0,10)); // YYYY-MM-DD
    }

    // collect indices for 08,10,...,20 each day
    const slotsPerDay = {};
    days.forEach(dateStr=>{
      slotsPerDay[dateStr] = [];
      for(let h=8; h<=20; h+=2){
        const hh = String(h).padStart(2,'0');
        // API times are local and formatted like YYYY-MM-DDThh:00
        let tStr = `${dateStr}T${hh}:00`;
        let idx = timeIndex[tStr];
        if(idx === undefined){
          idx = hourly.time.findIndex(ts => ts.startsWith(`${dateStr}T${hh}:`));
        }
        if(idx !== -1 && idx !== undefined) slotsPerDay[dateStr].push(idx);
      }
    });

    // Build table HTML
    let html = `<div class="spotCard" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">${spot.name}, ${spot.country}</div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="pill">kts</div>
          <div class="subtitle">Tijdzone: ${j.timezone || 'lokale tijd'}</div>
        </div>
      </div>`;

    // Current weather
    const curKts = cur && cur.windspeed !== undefined ? msToKts(cur.windspeed) : '—';
    const curDir = cur && cur.winddirection !== undefined ? degToCompass(cur.winddirection) : '—';
    const curTime = cur && cur.time ? cur.time.replace('T',' ') : '—';
    html += `<div style="margin-top:8px;color:var(--muted)"><strong>Actueel:</strong> <span style="font-weight:800">${curKts} kts</span> • richting <strong>${curDir}</strong> • ${curTime}</div>`;

    // Table header
    html += `<table class="wf-table"><thead><tr><th>Tijd</th><th>Wind</th><th>Stoot</th><th>Richting</th></tr></thead><tbody>`;

    // For each day: rows + superforecast
    for(const dateStr of days){
      const idxs = slotsPerDay[dateStr];
      // day header
      // find a sample time for label
      const sampleIdx = idxs.length ? idxs[0] : hourly.time.findIndex(t=>t.startsWith(dateStr));
      const sampleTime = hourly.time[sampleIdx] || (dateStr + 'T08:00');
      const dayLabel = new Date(sampleTime).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'});
      html += `<tr class="day-row"><td colspan="4">${dayLabel}</td></tr>`;

      if(!idxs || idxs.length===0){
        html += `<tr><td colspan="4" class="subtitle">Geen data voor 08–20</td></tr>`;
        continue;
      }

      // collect for superforecast
      const speeds = [];
      const gusts = [];

      for(const idx of idxs){
        const t = hourly.time[idx].replace('T',' ');
        const s_ms = Number(hourly.windspeed_10m[idx]);
        const g_ms = hourly.windgusts_10m ? Number(hourly.windgusts_10m[idx]) : NaN;
        const dirDeg = hourly.winddirection_10m ? Number(hourly.winddirection_10m[idx]) : NaN;

        if(isFinite(s_ms)) speeds.push(s_ms);
        if(isFinite(g_ms)) gusts.push(g_ms);

        const s_kts = isFinite(s_ms) ? msToKts(s_ms) : '—';
        const g_kts = isFinite(g_ms) ? msToKts(g_ms) : '—';
        const dirLabel = isFinite(dirDeg) ? degToCompass(dirDeg) : '—';

        // wind arrow uses inline CSS var --dir to rotate
        const arrowStyle = isFinite(dirDeg) ? `style="transform:rotate(${dirDeg}deg)"` : '';
        html += `<tr class="slot-row">
          <td class="time">${t}</td>
          <td><span class="kts">${s_kts} kts</span></td>
          <td><span class="gust">${g_kts} kts</span></td>
          <td><div class="wind-cell"><span class="wind-arrow" ${arrowStyle}></span><span class="subtitle">${dirLabel}</span></div></td>
        </tr>`;
      }

      // compute superforecast correctly on raw m/s values
      const avg_ms = speeds.length ? (speeds.reduce((a,b)=>a+b,0) / speeds.length) : NaN;
      const maxGust_ms = gusts.length ? Math.max(...gusts) : NaN;
      const avg_kts = isFinite(avg_ms) ? msToKts(avg_ms) : '—';
      const maxGust_kts = isFinite(maxGust_ms) ? msToKts(maxGust_ms) : '—';

      html += `<tr class="super-row"><td>Superforecast (08–20)</td><td>${avg_kts} kts</td><td>${maxGust_kts} kts</td><td class="subtitle">Daggemiddelde &amp; max stoot</td></tr>`;
    }

    html += `</tbody></table></div>`;
    container.innerHTML = html;
  }catch(e){
    console.error(e);
    container.innerHTML = `<div class="spotCard">Fout bij laden forecast</div>`;
  }
}
</script>
</body>
</html>
