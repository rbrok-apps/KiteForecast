<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KiteForecast — Windfinder stijl (10 dagen)</title>
<style>
:root{--bg:#eaf6ff;--card:#fff;--accent:#0b6fb8;--muted:#6b7b8a;--text:#042b3a;
  --calm:#dff6ff;--light:#bfefff;--moderate:#bff0d6;--fresh:#fff6c8;--strong:#ffd6b3;--very-strong:#ffb3b3;--extreme:#d7b3ff;}
html,body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#f3fbff);color:var(--text)}
.wrap{max-width:980px;margin:18px auto;padding:12px}
.searchCard{background:var(--card);padding:12px;border-radius:10px;display:flex;gap:8px;align-items:center}
input[type="search"]{flex:1;padding:10px;border-radius:8px;border:1px solid #d7eefc}
button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
.spotCard{background:linear-gradient(180deg,#fff,#f7fbff);padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 6px 18px rgba(6,30,50,0.04)}
.wf-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.92rem}
.wf-table th{background:linear-gradient(180deg,#e6f6ff,#dff3ff);padding:8px;text-align:left}
.wf-table td{padding:8px;border-bottom:1px solid #f0f6fb}
.day-row{background:#f3fbff;font-weight:700;color:var(--accent)}
.slot-row:hover{background:#f7fdff}
.wind-cell{display:flex;align-items:center;gap:8px}
.wind-arrow{width:26px;height:26px;position:relative;transform-origin:center center;display:inline-block}
.wind-arrow .shaft{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:2px;height:20px;background:#075a92;border-radius:2px}
.wind-arrow .head{position:absolute;left:50%;top:4px;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid #075a92}
.speed-pill{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;color:var(--text)}
.c-0{background:var(--calm)}.c-1{background:var(--light)}.c-2{background:var(--moderate)}.c-3{background:var(--fresh)}.c-4{background:var(--strong)}.c-5{background:var(--very-strong)}.c-6{background:var(--extreme)}
.pill{background:#e6f6ff;padding:6px 8px;border-radius:999px;font-weight:700}
.subtitle{color:var(--muted);font-size:0.9rem}
@media(max-width:640px){ .wf-table th:nth-child(1), .wf-table td:nth-child(1){display:none} }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>KiteForecast</h1><div class="subtitle">10 dagen • 2‑uurs slots 08:00–20:00 • superforecast in extra kolommen</div></header>
  <div class="searchCard"><input id="q" type="search" placeholder="Zoek spot — bijv. Tarifa, Langebaan, Scheveningen"><button id="searchBtn">Zoek</button></div>
  <div id="results" class="subtitle"></div>
  <div id="spotCard"></div>
</div>

<script>
const GEOCODE = name => `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=10&language=nl&format=json`;
const FORECAST = (lat,lon,days=10) => `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=windspeed_10m,windgusts_10m,winddirection_10m&current_weather=true&timezone=auto&forecast_days=${days}`;

/* exacte conversie: 1 m/s = 1.943844 kts */ 
function msToKtsNum(ms){ return ms * 1.943844; } /* numerieke */
function formatKts(ms){ return isFinite(ms) ? (msToKtsNum(ms)).toFixed(1) : '—'; }

function windColorClassFromKts(kts){
  if(!isFinite(kts)) return 'c-0';
  const v = Number(kts);
  if(v < 5) return 'c-0';
  if(v < 10) return 'c-1';
  if(v < 15) return 'c-2';
  if(v < 20) return 'c-3';
  if(v < 25) return 'c-4';
  if(v < 35) return 'c-5';
  return 'c-6';
}
function degToCompass(deg){
  if(!isFinite(deg)) return '—';
  const val = Math.floor((deg/22.5)+0.5);
  const arr = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return arr[val % 16];
}

/* search */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = document.getElementById('q').value.trim(); if(!q) return;
  const res = document.getElementById('results'); res.textContent='Zoeken...';
  try{ const r = await fetch(GEOCODE(q)); const j = await r.json();
    if(!j.results || !j.results.length){ res.textContent='Geen resultaten'; return; }
    res.innerHTML = j.results.map((s,i)=>`<div style="margin-top:8px"><button data-i="${i}" class="spotBtn" style="background:none;border:0;color:#075a92;cursor:pointer">${s.name}${s.admin1? ', '+s.admin1:''}, ${s.country}</button></div>`).join('');
    document.querySelectorAll('.spotBtn').forEach(b=>b.addEventListener('click', ()=> loadSpot(j.results[b.dataset.i])));
  }catch(e){ res.textContent='Fout bij zoeken'; }
});

/* main */
async function loadSpot(spot){
  const container = document.getElementById('spotCard');
  container.innerHTML = `<div class="spotCard"><strong>${spot.name}, ${spot.country}</strong><div class="subtitle">Laden…</div></div>`;
  try{
    const r = await fetch(FORECAST(spot.latitude, spot.longitude, 10));
    const j = await r.json(); const cur = j.current_weather; const hourly = j.hourly;
    if(!hourly || !hourly.time){ container.innerHTML = `<div class="spotCard">Geen data</div>`; return; }

    const timeIndex = {}; hourly.time.forEach((t,i)=> timeIndex[t]=i);
    const days = []; for(let d=0; d<10; d++){ const dt=new Date(); dt.setDate(dt.getDate()+d); days.push(dt.toISOString().slice(0,10)); }

    const slotsPerDay = {};
    days.forEach(dateStr=>{ slotsPerDay[dateStr]=[]; for(let h=8; h<=20; h+=2){
      const hh=String(h).padStart(2,'0'); let tStr=`${dateStr}T${hh}:00`; let idx=timeIndex[tStr];
      if(idx===undefined) idx = hourly.time.findIndex(ts=>ts.startsWith(`${dateStr}T${hh}:`));
      if(idx!==-1 && idx!==undefined) slotsPerDay[dateStr].push(idx);
    }});

    // precompute super per day (may be empty)
    const superPerDay = {};
    for(const dateStr of days){
      const idxs = slotsPerDay[dateStr]||[]; const speeds=[]; const gusts=[];
      for(const idx of idxs){ const s_ms=Number(hourly.windspeed_10m[idx]); const g_ms=Number(hourly.windgusts_10m?.[idx]);
        if(isFinite(s_ms)) speeds.push(s_ms); if(isFinite(g_ms)) gusts.push(g_ms);
      }
      const avg_ms = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length) : NaN;
      const maxGust_ms = gusts.length ? Math.max(...gusts) : NaN;
      superPerDay[dateStr] = { avg_ms, maxGust_ms, avg_kts: isFinite(avg_ms)? msToKtsNum(avg_ms): NaN, maxGust_kts: isFinite(maxGust_ms)? msToKtsNum(maxGust_ms): NaN };
    }

    // build html
    let html = `<div class="spotCard"><div style="display:flex;justify-content:space-between"><div style="font-weight:800">${spot.name}, ${spot.country}</div><div style="display:flex;gap:10px;align-items:center"><div class="pill">kts</div><div class="subtitle">${j.timezone||'lokale tijd'}</div></div></div>`;
    const curKtsNum = isFinite(cur?.windspeed) ? msToKtsNum(cur.windspeed) : NaN;
    const curKts = isFinite(curKtsNum)? curKtsNum.toFixed(1): '—';
    const curClass = windColorClassFromKts(curKtsNum);
    const curDir = degToCompass(cur?.winddirection);
    html += `<div style="margin-top:8px"><strong>Actueel:</strong> <span class="speed-pill ${curClass}">${curKts} kts</span> • richting <strong>${curDir}</strong> • ${cur?.time?.replace('T',' ')||'—'}</div>`;

    html += `<table class="wf-table"><thead><tr><th>Tijd</th><th>Wind</th><th>Stoot</th><th>Richting</th><th>Super avg</th><th>Super max stoot</th></tr></thead><tbody>`;
    for(const dateStr of days){
      const idxs = slotsPerDay[dateStr]; const sampleIdx = idxs?.[0] ?? hourly.time.findIndex(t=>t.startsWith(dateStr));
      const sampleTime = hourly.time[sampleIdx] || (dateStr+'T08:00');
      const dayLabel = new Date(sampleTime).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'});
      html += `<tr class="day-row"><td colspan="6">${dayLabel}</td></tr>`;
      if(!idxs || idxs.length===0){ html += `<tr><td colspan="6" class="subtitle">Geen data voor 08–20</td></tr>`; continue; }
      const superVals = superPerDay[dateStr];
      const superAvgKts = isFinite(superVals.avg_kts) ? superVals.avg_kts.toFixed(1) : '';
      const superMaxKts = isFinite(superVals.maxGust_kts) ? superVals.maxGust_kts.toFixed(1) : '';
      const superAvgClass = isFinite(superVals.avg_kts) ? windColorClassFromKts(superVals.avg_kts) : 'c-0';
      const superMaxClass = isFinite(superVals.maxGust_kts) ? windColorClassFromKts(superVals.maxGust_kts) : 'c-0';

      for(const idx of idxs){
        const t = hourly.time[idx].replace('T',' ');
        const s_ms = Number(hourly.windspeed_10m[idx]); const g_ms = Number(hourly.windgusts_10m?.[idx]); const dirDeg = Number(hourly.winddirection_10m?.[idx]);
        const s_kts_num = isFinite(s_ms)? msToKtsNum(s_ms): NaN; const s_kts = isFinite(s_kts_num)? s_kts_num.toFixed(1): '—';
        const g_kts = isFinite(g_ms)? msToKtsNum(g_ms).toFixed(1): '—';
        const dirLabel = isFinite(dirDeg)? degToCompass(dirDeg): '—';
        const arrowRotate = isFinite(dirDeg)? `transform:rotate(${dirDeg}deg)` : '';
        const speedClass = isFinite(s_kts_num)? windColorClassFromKts(s_kts_num) : 'c-0';
        html += `<tr class="slot-row"><td class="time">${t}</td><td><span class="speed-pill ${speedClass}">${s_kts} kts</span></td><td><span class="subtitle">${g_kts} kts</span></td><td><div class="wind-cell"><span class="wind-arrow" style="${arrowRotate}"><span class="shaft"></span><span class="head"></span></span><span class="subtitle">${dirLabel}</span></div></td><td>${superAvgKts? `<span class="speed-pill ${superAvgClass}">${superAvgKts} kts</span>` : ''}</td><td>${superMaxKts? `<span class="speed-pill ${superMaxClass}">${superMaxKts} kts</span>` : ''}</td></tr>`;
      }
    }
    html += `</tbody></table></div>`;
    container.innerHTML = html;
  }catch(e){ console.error(e); container.innerHTML = `<div class="spotCard">Fout bij laden forecast</div>`; }
}
</script>
</body>
</html>
