<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KiteForecast — Windfinder stijl (10 dagen, gecorrigeerd)</title>
<style>
:root{
  --bg:#eaf6ff; --card:#fff; --accent:#0b6fb8; --accent-dark:#075a92; --muted:#6b7b8a; --text:#042b3a;
  --calm:#dff6ff; --light:#bfefff; --moderate:#bff0d6; --fresh:#fff6c8; --strong:#ffd6b3; --very-strong:#ffb3b3; --extreme:#d7b3ff;
}
html,body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#f3fbff);color:var(--text)}
.wrap{max-width:980px;margin:18px auto;padding:12px}
header{display:flex;flex-direction:column;gap:6px}
h1{margin:0;font-size:1.4rem;color:var(--accent-dark)}
.subtitle{color:var(--muted);font-size:0.9rem}

/* Search area: smaller input + quick buttons */
.searchRow{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
.searchCard{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(6,30,50,0.06);display:flex;gap:8px;align-items:center}
input[type="search"]{width:320px;padding:8px;border-radius:8px;border:1px solid #d7eefc;font-size:0.95rem}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.quickButtons{display:flex;gap:6px}
.quickButtons button{background:#f0f8ff;border:1px solid #d7eefc;padding:8px 10px;border-radius:8px;color:var(--accent-dark);cursor:pointer;font-weight:700}

/* Spot card and table */
.spotCard{background:linear-gradient(180deg,#fff,#f7fbff);padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 6px 18px rgba(6,30,50,0.04)}
.wf-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.92rem}
.wf-table th{background:linear-gradient(180deg,#e6f6ff,#dff3ff);padding:8px;text-align:left}
.wf-table td{padding:8px;border-bottom:1px solid #f0f6fb}
.day-row{background:#f3fbff;font-weight:700;color:var(--accent)}
.slot-row:hover{background:#f7fdff}

/* Wind arrow (shaft + head) — langere shaft */
.wind-cell{display:flex;align-items:center;gap:8px}
.wind-arrow{width:34px;height:34px;position:relative;transform-origin:center center;display:inline-block}
.wind-arrow .shaft{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:2px;height:28px;background:#075a92;border-radius:2px}
.wind-arrow .head{position:absolute;left:50%;top:2px;transform:translateX(-50%);width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:12px solid #075a92}

/* pills and colors */
.speed-pill{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;color:var(--text)}
.c-0{background:var(--calm)}.c-1{background:var(--light)}.c-2{background:var(--moderate)}.c-3{background:var(--fresh)}.c-4{background:var(--strong)}.c-5{background:var(--very-strong)}.c-6{background:var(--extreme)}
.pill{background:#e6f6ff;padding:6px 8px;border-radius:999px;font-weight:700}
.subtitle{color:var(--muted);font-size:0.9rem}

/* responsive */
@media(max-width:880px){
  input[type="search"]{width:220px}
}
@media(max-width:640px){
  .wf-table th:nth-child(1), .wf-table td:nth-child(1){display:none}
  .wind-arrow{width:26px;height:26px}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>KiteForecast</h1>
        <div class="subtitle">10 dagen • 2‑uurs slots 08:00–20:00 • superforecast in extra kolommen</div>
      </div>
    </div>
  </header>

  <div class="searchRow">
    <div class="searchCard" role="search">
      <input id="q" type="search" placeholder="Zoek spot — bijv. Tarifa, Langebaan, Scheveningen" />
      <button id="searchBtn" class="btn">Zoek</button>
      <div style="margin-left:8px" class="pill">kts</div>
    </div>

    <div class="quickButtons" aria-hidden="false">
      <button data-spot="wijk">Wijk aan Zee</button>
      <button data-spot="ouddorp">Ouddorp</button>
      <button data-spot="brouwersdam">Brouwersdam</button>
      <button data-spot="rockanje">Rockanje</button>
      <button data-spot="zandmotor">Zandmotor</button>
    </div>
  </div>

  <div id="results" class="subtitle" style="margin-top:8px"></div>
  <div id="spotCard"></div>
</div>

<script>
/* API endpoints */
const GEOCODE = name => `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=10&language=nl&format=json`;
const FORECAST = (lat,lon,days=10) => `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=windspeed_10m,windgusts_10m,winddirection_10m&current_weather=true&timezone=auto&forecast_days=${days}`;

/* Exact conversion: 1 m/s = 1.943844 kts (apply once) */
const KTS_PER_MS = 1.943844;
function msToKtsRounded(ms){
  if(!Number.isFinite(ms)) return null;
  return Math.round(ms * KTS_PER_MS); // integer knopen
}

/* Color buckets based on kts (Windfinder-like thresholds) */
function windColorClassFromKts(kts){
  if(!Number.isFinite(kts)) return 'c-0';
  const v = Number(kts);
  if(v < 5) return 'c-0';
  if(v < 10) return 'c-1';
  if(v < 15) return 'c-2';
  if(v < 20) return 'c-3';
  if(v < 25) return 'c-4';
  if(v < 35) return 'c-5';
  return 'c-6';
}

/* Compass label (16 sectors) */
function degToCompass(deg){
  if(!Number.isFinite(deg)) return '—';
  const val = Math.floor((deg/22.5)+0.5);
  const arr = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return arr[val % 16];
}

/* Quick spots (approx coords) */
const QUICK_SPOTS = {
  wijk: { name: "Wijk aan Zee", lat: 52.4410, lon: 4.6450 },
  ouddorp: { name: "Ouddorp", lat: 51.7830, lon: 3.9000 },
  brouwersdam: { name: "Brouwersdam", lat: 51.7000, lon: 3.9000 },
  rockanje: { name: "Rockanje", lat: 51.8500, lon: 4.1200 },
  zandmotor: { name: "Zandmotor", lat: 52.0200, lon: 4.1200 }
};

/* UI: search */
const resultsEl = document.getElementById('results');
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = document.getElementById('q').value.trim(); if(!q) return;
  resultsEl.textContent = 'Zoeken...';
  try{
    const r = await fetch(GEOCODE(q));
    const j = await r.json();
    if(!j.results || j.results.length===0){ resultsEl.textContent='Geen resultaten'; return; }
    // show list
    resultsEl.innerHTML = j.results.map((s,i)=>`<div style="margin-top:6px"><button data-i="${i}" class="spotBtn" style="background:none;border:0;color:#075a92;cursor:pointer;font-weight:700">${s.name}${s.admin1? ', '+s.admin1:''}, ${s.country}</button></div>`).join('');
    document.querySelectorAll('.spotBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const idx = btn.dataset.i;
        const spot = j.results[idx];
        // hide results list
        resultsEl.innerHTML = '';
        loadSpot({ name: spot.name, lat: spot.latitude, lon: spot.longitude, country: spot.country });
      });
    });
  }catch(e){
    resultsEl.textContent='Fout bij zoeken';
    console.error(e);
  }
});

/* Quick buttons behavior */
document.querySelectorAll('.quickButtons button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const key = btn.dataset.spot;
    const spot = QUICK_SPOTS[key];
    // hide results list and clear search input
    resultsEl.innerHTML = '';
    document.getElementById('q').value = '';
    loadSpot({ name: spot.name, lat: spot.lat, lon: spot.lon });
  });
});

/* Main loader */
async function loadSpot(spot){
  const container = document.getElementById('spotCard');
  container.innerHTML = `<div class="spotCard"><strong>${spot.name}</strong><div class="subtitle">Laden forecast…</div></div>`;
  try{
    const r = await fetch(FORECAST(spot.lat ?? spot.latitude, spot.lon ?? spot.longitude, 10));
    const j = await r.json();
    const cur = j.current_weather;
    const hourly = j.hourly;
    if(!hourly || !hourly.time){ container.innerHTML = `<div class="spotCard">Geen forecastdata beschikbaar</div>`; return; }

    // map time -> index
    const timeIndex = {}; hourly.time.forEach((t,i)=> timeIndex[t]=i);

    // days: next 10 days
    const days = []; for(let d=0; d<10; d++){ const dt=new Date(); dt.setDate(dt.getDate()+d); days.push(dt.toISOString().slice(0,10)); }

    // collect indices for 08,10,...,20 each day
    const slotsPerDay = {};
    days.forEach(dateStr=>{
      slotsPerDay[dateStr]=[];
      for(let h=8; h<=20; h+=2){
        const hh = String(h).padStart(2,'0');
        let tStr = `${dateStr}T${hh}:00`;
        let idx = timeIndex[tStr];
        if(idx === undefined) idx = hourly.time.findIndex(ts => ts.startsWith(`${dateStr}T${hh}:`));
        if(idx !== -1 && idx !== undefined) slotsPerDay[dateStr].push(idx);
      }
    });

    // precompute super per day (avg m/s across slots 08-20, max gust m/s)
    const superPerDay = {};
    for(const dateStr of days){
      const idxs = slotsPerDay[dateStr] || [];
      const speeds = []; const gusts = [];
      for(const idx of idxs){
        const s_ms = Number(hourly.windspeed_10m[idx]);
        const g_ms = Number(hourly.windgusts_10m?.[idx]);
        if(Number.isFinite(s_ms)) speeds.push(s_ms);
        if(Number.isFinite(g_ms)) gusts.push(g_ms);
      }
      const avg_ms = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length) : NaN;
      const maxGust_ms = gusts.length ? Math.max(...gusts) : NaN;
      superPerDay[dateStr] = {
        avg_ms,
        maxGust_ms,
        avg_kts_rounded: Number.isFinite(avg_ms) ? msToKtsRounded(avg_ms) : null,
        maxGust_kts_rounded: Number.isFinite(maxGust_ms) ? msToKtsRounded(maxGust_ms) : null
      };
    }

    // build html
    let html = `<div class="spotCard"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${spot.name}${spot.country? ', '+spot.country:''}</div><div style="display:flex;gap:10px;align-items:center"><div class="pill">kts</div><div class="subtitle">Tijdzone: ${j.timezone || 'lokale tijd'}</div></div></div>`;

    // current weather (color sensitive)
    const curKtsRounded = Number.isFinite(cur?.windspeed) ? msToKtsRounded(cur.windspeed) : null;
    const curKtsDisplay = curKtsRounded !== null ? curKtsRounded : '—';
    const curClass = windColorClassFromKts(curKtsRounded);
    const curDir = degToCompass(cur?.winddirection);
    html += `<div style="margin-top:8px"><strong>Actueel:</strong> <span class="speed-pill ${curClass}">${curKtsDisplay} kts</span> • richting <strong>${curDir}</strong> • ${cur?.time?.replace('T',' ')||'—'}</div>`;

    // table header
    html += `<table class="wf-table"><thead><tr><th>Tijd</th><th>Wind</th><th>Stoot</th><th>Richting</th><th>Super avg</th><th>Super max stoot</th></tr></thead><tbody>`;

    for(const dateStr of days){
      const idxs = slotsPerDay[dateStr];
      const sampleIdx = idxs?.[0] ?? hourly.time.findIndex(t=>t.startsWith(dateStr));
      const sampleTime = hourly.time[sampleIdx] || (dateStr + 'T08:00');
      const dayLabel = new Date(sampleTime).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'});
      html += `<tr class="day-row"><td colspan="6">${dayLabel}</td></tr>`;

      if(!idxs || idxs.length===0){
        html += `<tr><td colspan="6" class="subtitle">Geen data voor 08–20</td></tr>`;
        continue;
      }

      const superVals = superPerDay[dateStr];
      const superAvgDisplay = Number.isFinite(superVals.avg_kts_rounded) ? superVals.avg_kts_rounded : '';
      const superMaxDisplay = Number.isFinite(superVals.maxGust_kts_rounded) ? superVals.maxGust_kts_rounded : '';
      const superAvgClass = Number.isFinite(superVals.avg_kts_rounded) ? windColorClassFromKts(superVals.avg_kts_rounded) : 'c-0';
      const superMaxClass = Number.isFinite(superVals.maxGust_kts_rounded) ? windColorClassFromKts(superVals.maxGust_kts_rounded) : 'c-0';

      for(const idx of idxs){
        const t = hourly.time[idx].replace('T',' ');
        const s_ms = Number(hourly.windspeed_10m[idx]);
        const g_ms = Number(hourly.windgusts_10m?.[idx]);
        const dirDeg = Number(hourly.winddirection_10m?.[idx]);

        // convert once and round to integer knopen
        const s_kts_rounded = Number.isFinite(s_ms) ? msToKtsRounded(s_ms) : null;
        const s_kts_display = s_kts_rounded !== null ? s_kts_rounded : '—';
        const g_kts_rounded = Number.isFinite(g_ms) ? msToKtsRounded(g_ms) : null;
        const g_kts_display = g_kts_rounded !== null ? g_kts_rounded : '—';

        const dirLabel = Number.isFinite(dirDeg) ? degToCompass(dirDeg) : '—';
        // rotate arrow so the arrowhead points to where the wind is going:
        // API gives winddirection = direction FROM which wind blows -> add 180 to point TO
        const arrowRotation = Number.isFinite(dirDeg) ? ( (dirDeg + 180) % 360 ) : 0;
        const arrowStyle = `transform:rotate(${arrowRotation}deg)`;
        const speedClass = Number.isFinite(s_kts_rounded) ? windColorClassFromKts(s_kts_rounded) : 'c-0';

        html += `<tr class="slot-row">
          <td class="time">${t}</td>
          <td><span class="speed-pill ${speedClass}">${s_kts_display} kts</span></td>
          <td><span class="subtitle">${g_kts_display} kts</span></td>
          <td><div class="wind-cell"><span class="wind-arrow" style="${arrowStyle}"><span class="shaft"></span><span class="head"></span></span><span class="subtitle">${dirLabel}</span></div></td>
          <td>${superAvgDisplay !== '' ? `<span class="speed-pill ${superAvgClass}">${superAvgDisplay} kts</span>` : ''}</td>
          <td>${superMaxDisplay !== '' ? `<span class="speed-pill ${superMaxClass}">${superMaxDisplay} kts</span>` : ''}</td>
        </tr>`;
      }
    }

    html += `</tbody></table></div>`;
    container.innerHTML = html;

    // hide results list and clear search input after loading
    resultsEl.innerHTML = '';
    document.getElementById('q').value = '';
  }catch(e){
    console.error(e);
    container.innerHTML = `<div class="spotCard">Fout bij laden forecast</div>`;
  }
}
</script>
</body>
</html>
